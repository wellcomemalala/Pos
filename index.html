<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>หน้าจอครัว - นักซิ่ง (ระบบแยกคิวอัจฉริยะ)</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    html { touch-action: manipulation; }
    body { font-family: 'Tahoma', sans-serif; background-color: #f0f2f5; color: #000; margin: 0; padding: 10px; }
    
    #syncStatusBar { position: fixed; top: 0; left: 0; right: 0; height: 35px; background: #27ae60; color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; z-index: 1001; }
    #syncStatusBar.offline { background: #c0392b; }

    .controls { margin: 45px 0 15px; background: #ffffff; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .chef-selector { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .selector-btn { padding: 12px 20px; font-size: 20px; font-weight: bold; border: 3px solid #ddd; border-radius: 10px; cursor: pointer; background: #f8f9fa; color: #555; transition: 0.2s; flex: 1; min-width: 100px; }
    .selector-btn.active { background: #007bff; color: white; border-color: #0056b3; box-shadow: 0 4px 12px rgba(0,123,255,0.3); }

    .kitchen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; margin-top: 10px; }
    .chef-column { background: #ffffff; border-radius: 20px; padding: 15px; min-height: 500px; border: 2px solid #dee2e6; box-shadow: 0 6px 15px rgba(0,0,0,0.05); }
    .chef-column h3 { text-align: center; font-size: 32px; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 4px solid #007bff; color: #007bff; }

    .order-card { 
      background: #ffffff; margin-bottom: 15px; padding: 0; border-radius: 15px; 
      border: 3px solid #007bff; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .card-header { background: #007bff; color: white; padding: 10px 15px; font-size: 28px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .card-header.ready { background: #6c757d; text-decoration: line-through; opacity: 0.8; }
    
    .card-comment { background: #fff3cd; color: #856404; padding: 5px 15px; font-size: 20px; font-weight: bold; border-bottom: 1px solid #ffeeba; }

    .table-list { padding: 5px 0; background: white; }
    .table-item { 
      padding: 15px 20px; font-size: 26px; font-weight: bold; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .table-item:last-child { border-bottom: none; }

    .table-item.ready { background: #e8f5e9; color: #aaa; text-decoration: line-through; }
    .table-item.ready .qty-circle { background: #aaa; }

    .qty-circle { background: #007bff; color: white; min-width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .home-tag { color: #e74c3c; font-size: 18px; margin-left: 10px; border: 2px solid #e74c3c; padding: 2px 5px; border-radius: 5px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="syncStatusBar"><span id="syncStatusText">กำลังเชื่อมต่อ...</span></div>
  <div class="controls">
    <div class="chef-selector">
      <button class="selector-btn active" onclick="toggleChef('kik', this)">กิ๊ก</button>
      <button class="selector-btn active" onclick="toggleChef('jeab', this)">เจี๊ยบ</button>
      <button class="selector-btn active" onclick="toggleChef('nan', this)">พลโท</button>
      <button class="selector-btn active" onclick="toggleChef('see', this)">ซี</button>
    </div>
  </div>

  <div class="kitchen-grid" id="kitchenGrid">
    <div class="chef-column" id="col-kik"><h3>กิ๊ก</h3><div id="list-kik"></div></div>
    <div class="chef-column" id="col-jeab"><h3>เจี๊ยบ</h3><div id="list-jeab"></div></div>
    <div class="chef-column" id="col-nan"><h3>พลโท</h3><div id="list-nan"></div></div>
    <div class="chef-column" id="col-see"><h3>ซี</h3><div id="list-see"></div></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDskwJlUNbr3zkKnyY_-n582PdoCrts2AE",
      authDomain: "supertest01-55ac2.firebaseapp.com",
      databaseURL: "https://supertest01-55ac2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "supertest01-55ac2",
      storageBucket: "supertest01-55ac2.firebasestorage.app",
      messagingSenderId: "846236839338",
      appId: "1:846236839338:web:260ca9b6af72c69837cfd3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const BASE_PATH = "racing_order_app/";

    const chefMenus = {
      'kik':['ต้มแซ่บ','คั่ว','ผักหวาน','แป๊ะซะ','แวะถัวะ','ผัดเผ็ด','อ่อม','แกงป่าผัก','แกงป่าหน่อไม้ดอง','แกงป่าหน่อไม้สด','บอน','มะรุม','กระบุก','แกงไก่หน่อ','แกงหมูหน่อ','แกงเนื้อหน่อ','แกงปลา','ผัดฉ่า','ปลาร้า','ไก่น้ำปลา','สามชั้น','หมูน้ำปลา','โสม','ผักหวานเห็ดเผาะ','ผักหวานไข่มดแดงใส่เห็ดเผาะ'],
      'jeab':['ไข่เจียว','แกงหอย','พิเศษ','ทอง','แถม','หมกหม้อ','ขี้เหล็ก','ต้มจืด','ทอดมัน','หมกปลานิล','ไก่หลงทาง'],
      'nan':['ขาหมู','ข้าว','ขนม','นึ่ง'],
      'see':['ลาบ','ปลาเนื้ออ่อน','ปลานิลแดดเดียว','สมุนไพร','สะเดาน้ำปลาหวาน','ตำ']
    };

    const nonBatchableMenuItems = ['ปลาช่อนแป๊ะซะ','ปลาช่อนแวะถัวะ','อ่อมหมู','ผักหวานไข่มดแดง','ผักหวาน','ผักหวานเห็ดเผาะ','ผักหวานไข่มดแดงใส่เห็ดเผาะ','ไข่เจียวบาว','ไข่เจียวธรรมดา','ไข่เจียวหมูสับ','ไข่เจียวไข่มดแดง'];

    let activeChefs = ['kik', 'jeab', 'nan', 'see'];
    let currentOrders = [];

    function toggleChef(chef, btn) {
      if (activeChefs.includes(chef)) {
        activeChefs = activeChefs.filter(c => c !== chef);
        btn.classList.remove('active');
        document.getElementById('col-' + chef).classList.add('hidden');
      } else {
        activeChefs.push(chef);
        btn.classList.add('active');
        document.getElementById('col-' + chef).classList.remove('hidden');
      }
    }

    function toggleItemReady(id, currentStatus) {
      const newStatus = (currentStatus === 'ready') ? 'pending' : 'ready';
      db.ref(BASE_PATH + 'orders/' + id + '/status').set(newStatus);
    }

    function toggleGroupReady(orderIdsStr, isAllReady) {
        const orderIds = JSON.parse(orderIdsStr);
        const newStatus = isAllReady ? 'pending' : 'ready';
        const updates = {};
        orderIds.forEach(id => {
            updates[BASE_PATH + 'orders/' + id + '/status'] = newStatus;
        });
        db.ref().update(updates);
    }

    db.ref(BASE_PATH + 'orders').on('value', (snapshot) => {
      const data = snapshot.val();
      currentOrders = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })) : [];
      renderOrders();
    });

    function renderOrders() {
      ['kik', 'jeab', 'nan', 'see'].forEach(id => document.getElementById('list-' + id).innerHTML = '');

      const summaryGroups = []; 
      
      currentOrders.forEach(o => {
        const isNonBatchable = nonBatchableMenuItems.includes(o.item);
        let targetGroup = null;

        if (!isNonBatchable) {
            // ค้นหาใบงานที่เมนูเหมือนกัน คอมเมนต์เหมือนกัน และ "ยังไม่มีใครถูกขีดฆ่าแม้แต่คนเดียว"
            targetGroup = summaryGroups.find(g => 
                g.item === o.item && 
                (g.comment || "") === (o.comment || "") &&
                !g.subOrders.some(so => so.status === 'ready')
            );
        }

        if (targetGroup) {
          targetGroup.totalQty += Number(o.quantity);
          targetGroup.subOrders.push(o);
          if (new Date(o.timestamp) < new Date(targetGroup.minTs)) {
              targetGroup.minTs = o.timestamp;
          }
        } else {
          summaryGroups.push({ 
            item: o.item, 
            comment: o.comment, 
            totalQty: Number(o.quantity),
            subOrders: [o],
            minTs: o.timestamp 
          });
        }
      });

      const sortedSummary = summaryGroups.sort((a, b) => new Date(a.minTs) - new Date(b.minTs));

      sortedSummary.forEach(group => {
        for (let [chef, menus] of Object.entries(chefMenus)) {
          if (menus.some(m => group.item.includes(m))) {
            const card = document.createElement('div');
            card.className = 'order-card';

            const isAllReady = group.subOrders.every(so => so.status === 'ready');
            const groupOrderIds = JSON.stringify(group.subOrders.map(so => so.id));

            let headerHtml = `<div class="card-header ${isAllReady ? 'ready' : ''}" 
                onclick='toggleGroupReady(${JSON.stringify(groupOrderIds)}, ${isAllReady})'>
                <span>${group.item}</span>
                <span class="qty-circle" style="background:white; color:#007bff;">${group.totalQty}</span>
            </div>`;
            
            let commentHtml = group.comment ? `<div class="card-comment">⚠️ ${group.comment}</div>` : '';

            let listHtml = '<div class="table-list">';
            group.subOrders.forEach(order => {
                const isReady = order.status === 'ready';
                const isHome = /[ก-๙]/.test(order.table);
                listHtml += `
                    <div class="table-item ${isReady ? 'ready' : ''}" onclick="event.stopPropagation(); toggleItemReady('${order.id}', '${order.status}')">
                        <span>
                            โต๊ะ ${order.table} ${isHome ? '<span class="home-tag">กลับบ้าน</span>' : ''}
                        </span>
                        <span class="qty-circle">${order.quantity}</span>
                    </div>
                `;
            });
            listHtml += '</div>';

            card.innerHTML = headerHtml + commentHtml + listHtml;
            document.getElementById('list-' + chef).appendChild(card);
            break;
          }
        }
      });
    }

    db.ref(".info/connected").on("value", (snap) => {
      const txt = document.getElementById('syncStatusText');
      txt.textContent = snap.val() ? "เชื่อมต่อครัวออนไลน์" : "ขาดการเชื่อมต่อ!";
      document.getElementById('syncStatusBar').classList.toggle('offline', !snap.val());
    });
  </script>
</body>
</html>